generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int            @id @default(autoincrement())
  email         String         @unique
  passwordHash  String
  name          String
  role          Role           @default(WAITER)
  createdAt     DateTime       @default(now())
  branchId      Int? // üîó cada usuario puede pertenecer a una sede
  branch        Branch?        @relation(fields: [branchId], references: [id])
  refreshTokens RefreshToken[]

  // Relaciones
  // ‚Üê lado opuesto de Order.createdBy (nombra la relaci√≥n)
  ordersCreated Order[]         @relation("OrdersCreatedBy")
  StockMovement StockMovement[]
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())
}

enum Role {
  ADMIN
  MANAGER
  WAITER
  CASHIER
}

model Branch {
  id        Int      @id @default(autoincrement())
  name      String
  location  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  users          User[]
  tables         Table[]
  products       Product[] // ‚Üê lado opuesto de Product.branch
  orders         Order[] // ‚Üê lado opuesto de Order.branch
  stockMovements StockMovement[]
}

model Table {
  id        Int      @id @default(autoincrement())
  number    Int
  capacity  Int
  status    String   @default("AVAILABLE") // AVAILABLE | OCCUPIED | RESERVED
  createdAt DateTime @default(now())

  branchId Int?
  branch   Branch? @relation(fields: [branchId], references: [id])
  orders   Order[] // ‚Üê lado opuesto de Order.table
}

model Product {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  price       Decimal  @db.Decimal(10, 2)
  status      String   @default("ACTIVE") // ACTIVE | INACTIVE
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  stockQty    Int      @default(0) // ‚Üê NUEVO

  // Relaci√≥n con Branch (obligatoria para respetar la l√≥gica por sede)
  branchId      Int
  branch        Branch          @relation(fields: [branchId], references: [id])
  orderItems    OrderItem[] // ‚Üê lado opuesto de OrderItem.product
  StockMovement StockMovement[]
}

model Order {
  id             Int             @id @default(autoincrement())
  status         OrderStatus     @default(PENDING) // PENDING | PAID | CANCELLED
  total          Decimal         @db.Decimal(10, 2)
  notes          String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  stockMovements StockMovement[]

  // Relaci√≥n con sede y mesa
  branchId Int
  branch   Branch @relation(fields: [branchId], references: [id])
  tableId  Int
  table    Table  @relation(fields: [tableId], references: [id])

  // Qui√©n cre√≥ el pedido (mesero/admin/manager/cashier)
  createdById Int
  createdBy   User @relation("OrdersCreatedBy", fields: [createdById], references: [id])

  // Items
  items OrderItem[]
}

model OrderItem {
  id        Int      @id @default(autoincrement())
  quantity  Int
  unitPrice Decimal  @db.Decimal(10, 2) // precio capturado al momento
  subtotal  Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  // Relaci√≥n con Order y Product
  orderId   Int
  order     Order   @relation(fields: [orderId], references: [id])
  productId Int
  product   Product @relation(fields: [productId], references: [id])
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
}

enum StockMovementType {
  IN // entrada (compra, reposici√≥n)
  OUT // salida (venta, merma)
  ADJUST // ajuste manual (correcci√≥n)
}

model StockMovement {
  id        Int               @id @default(autoincrement())
  type      StockMovementType
  quantity  Int
  reason    String?
  createdAt DateTime          @default(now())

  // Relaciones
  productId Int
  product   Product @relation(fields: [productId], references: [id])

  branchId Int
  branch   Branch @relation(fields: [branchId], references: [id])

  orderId Int?
  order   Order? @relation(fields: [orderId], references: [id])

  createdById Int
  createdBy   User @relation(fields: [createdById], references: [id])
}
