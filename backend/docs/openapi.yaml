openapi: 3.0.3
info:
  title: Restaurant/Bar API
  version: 1.0.0
  description: >
    Backend para gesti√≥n de restaurante/bar con multisucursal.
    Incluye auth con JWT + Refresh, roles (MANAGER, ADMIN, WAITER, CASHIER),
    Branches, Tables, Products, Orders (con items), Stock y reportes de stock.
servers:
  - url: http://localhost:4000
    description: Local

tags:
  - name: Auth
  - name: Users
  - name: Branches
  - name: Tables
  - name: Products
  - name: Orders
  - name: Stock
  - name: Stock Summary

paths:
  /api/auth/register:
    post:
      tags: [Auth]
      summary: Register user
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RegisterRequest' }
      responses:
        "201":
          description: User created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UserPublic' }

  /api/auth/login:
    post:
      tags: [Auth]
      summary: Login (returns access + refresh)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/LoginRequest' }
      responses:
        "200":
          description: Login OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/LoginResponse' }

  /api/auth/refresh:
    post:
      tags: [Auth]
      summary: Refresh session (rotate refresh, new access token)
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                refreshToken:
                  type: string
                  description: Optional if refreshToken cookie is present
      responses:
        "200":
          description: New tokens
          content:
            application/json:
              schema: { $ref: '#/components/schemas/RefreshResponse' }

  /api/auth/logout:
    post:
      tags: [Auth]
      summary: Logout (revokes refresh token and clears cookie)
      responses:
        "200":
          description: Logged out

  /api/auth/profile:
    get:
      tags: [Auth]
      summary: Get authenticated profile
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: Current user
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UserPublic' }

  /api/users:
    get:
      tags: [Users]
      summary: List users (MANAGER, ADMIN)
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: Users
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/UserPublic' }

  /api/users/{id}:
    get:
      tags: [Users]
      summary: Get user by id (MANAGER, ADMIN)
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: User
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UserPublic' }
    put:
      tags: [Users]
      summary: Update role and/or branch (MANAGER only)
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                role:
                  type: string
                  enum: [MANAGER, ADMIN, WAITER, CASHIER]
                branchId:
                  type: integer
      responses:
        "200":
          description: Updated
    delete:
      tags: [Users]
      summary: Delete user (MANAGER only)
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: Deleted

  /api/branches:
    get:
      tags: [Branches]
      summary: List branches
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: Branches
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Branch' }
    post:
      tags: [Branches]
      summary: Create branch
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/BranchCreate' }
      responses:
        "201":
          description: Created

  /api/branches/{id}:
    get:
      tags: [Branches]
      summary: Get branch (includes tables/users)
      security: [{ bearerAuth: [] }]
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        "200":
          description: Branch
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Branch' }
    put:
      tags: [Branches]
      summary: Update branch
      security: [{ bearerAuth: [] }]
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/BranchCreate' }
      responses:
        "200": { description: Updated }
    delete:
      tags: [Branches]
      summary: Delete branch
      security: [{ bearerAuth: [] }]
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        "200": { description: Deleted }

  /api/tables:
    get:
      tags: [Tables]
      summary: List tables (ADMIN see their branch, MANAGER all)
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: branchId
          schema: { type: integer }
      responses:
        "200":
          description: Tables
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Table' }
    post:
      tags: [Tables]
      summary: Create table (MANAGER)
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/TableCreate' }
      responses:
        "201": { description: Created }
  /api/tables/{id}:
    get:
      tags: [Tables]
      summary: Get table
      security: [{ bearerAuth: [] }]
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        "200":
          description: Table
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Table' }
    put:
      tags: [Tables]
      summary: Update table (MANAGER)
      security: [{ bearerAuth: [] }]
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/TableUpdate' }
      responses:
        "200": { description: Updated }
    delete:
      tags: [Tables]
      summary: Delete table (MANAGER)
      security: [{ bearerAuth: [] }]
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        "200": { description: Deleted }

  /api/products:
    get:
      tags: [Products]
      summary: List products (ADMIN branch-only, MANAGER all)
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: Products
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Product' }
    post:
      tags: [Products]
      summary: Create product (ADMIN=own branch, MANAGER=any)
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ProductCreate' }
      responses:
        "201": { description: Created }
  /api/products/{id}:
    get:
      tags: [Products]
      summary: Get product (scope by branch)
      security: [{ bearerAuth: [] }]
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        "200":
          description: Product
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Product' }
    put:
      tags: [Products]
      summary: Update product (ADMIN=their branch, MANAGER any; ADMIN cannot move branch)
      security: [{ bearerAuth: [] }]
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ProductUpdate' }
      responses:
        "200": { description: Updated }
    delete:
      tags: [Products]
      summary: Delete product (scope by branch)
      security: [{ bearerAuth: [] }]
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        "200": { description: Deleted }

  /api/orders:
    post:
      tags: [Orders]
      summary: Create order for a table (sets table OCCUPIED)
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CreateOrderRequest' }
      responses:
        "201": { description: Created }
    get:
      tags: [Orders]
      summary: List orders (MANAGER all; others by branch)
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: tableId
          schema: { type: integer }
        - in: query
          name: status
          schema: { type: string, enum: [PENDING, PAID, CANCELLED] }
      responses:
        "200":
          description: Orders
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Order' }

  /api/orders/{id}:
    get:
      tags: [Orders]
      summary: Get order (scope by branch)
      security: [{ bearerAuth: [] }]
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      responses:
        "200":
          description: Order
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Order' }

  /api/orders/{id}/items:
    post:
      tags: [Orders]
      summary: Add item to order (PENDING only)
      security: [{ bearerAuth: [] }]
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AddItemRequest' }
      responses:
        "200": { description: Item added (recalculated total) }

  /api/orders/{id}/items/{itemId}:
    put:
      tags: [Orders]
      summary: Update item quantity (PENDING only)
      security: [{ bearerAuth: [] }]
      parameters:
        - { in: path, name: id, required: true, schema: { type: integer } }
        - { in: path, name: itemId, required: true, schema: { type: integer } }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/UpdateItemQtyRequest' }
      responses:
        "200": { description: Item updated + total recalculated }
    delete:
      tags: [Orders]
      summary: Remove item (PENDING only)
      security: [{ bearerAuth: [] }]
      parameters:
        - { in: path, name: id, required: true, schema: { type: integer } }
        - { in: path, name: itemId, required: true, schema: { type: integer } }
      responses:
        "200": { description: Item removed + total recalculated }

  /api/orders/{id}/status:
    put:
      tags: [Orders]
      summary: Update order status (PAID deducts stock & frees table)
      security: [{ bearerAuth: [] }]
      parameters: [{ in: path, name: id, required: true, schema: { type: integer } }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  type: string
                  enum: [PENDING, PAID, CANCELLED]
      responses:
        "200": { description: Updated }

  /api/stock/adjust:
    post:
      tags: [Stock]
      summary: Adjust stock (IN/OUT/ADJUST)
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/StockAdjustRequest' }
      responses:
        "200": { description: Stock adjusted }

  /api/stock/movements:
    get:
      tags: [Stock]
      summary: Stock movements (MANAGER all; ADMIN by branch)
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: productId
          schema: { type: integer }
        - in: query
          name: limit
          schema: { type: integer, default: 50 }
      responses:
        "200":
          description: Movements
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/StockMovement' }

  /api/stock/summary:
    get:
      tags: [Stock Summary]
      summary: Stock summary (GLOBAL for MANAGER, BRANCH for ADMIN)
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: Summary
          content:
            application/json:
              schema: { $ref: '#/components/schemas/StockSummaryResponse' }

  /api/stock/by-branch:
    get:
      tags: [Stock Summary]
      summary: Stock by branch (ADMIN forced to own branch)
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: branchId
          schema: { type: integer }
      responses:
        "200":
          description: Branch stock listing
          content:
            application/json:
              schema:
                type: object

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    RegisterRequest:
      type: object
      required: [name, email, password, role]
      properties:
        name: { type: string }
        email: { type: string, format: email }
        password: { type: string, format: password }
        role: { type: string, enum: [MANAGER, ADMIN, WAITER, CASHIER] }

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email }
        password: { type: string, format: password }

    LoginResponse:
      type: object
      properties:
        message: { type: string }
        accessToken: { type: string }
        refreshToken: { type: string }
        user: { $ref: '#/components/schemas/UserPublic' }

    RefreshResponse:
      type: object
      properties:
        message: { type: string }
        accessToken: { type: string }
        refreshToken: { type: string }

    UserPublic:
      type: object
      properties:
        id: { type: integer }
        name: { type: string }
        email: { type: string }
        role: { type: string }
        branchId: { type: integer, nullable: true }

    Branch:
      type: object
      properties:
        id: { type: integer }
        name: { type: string }
        location: { type: string, nullable: true }

    BranchCreate:
      type: object
      required: [name]
      properties:
        name: { type: string }
        location: { type: string }

    Table:
      type: object
      properties:
        id: { type: integer }
        number: { type: integer }
        capacity: { type: integer }
        status: { type: string, enum: [AVAILABLE, OCCUPIED, RESERVED] }
        branchId: { type: integer, nullable: true }

    TableCreate:
      type: object
      required: [number, capacity]
      properties:
        number: { type: integer }
        capacity: { type: integer }
        status: { type: string }
        branchId: { type: integer }

    TableUpdate:
      type: object
      properties:
        number: { type: integer }
        capacity: { type: integer }
        status: { type: string }
        branchId: { type: integer }

    Product:
      type: object
      properties:
        id: { type: integer }
        name: { type: string }
        description: { type: string, nullable: true }
        price: { type: string }
        status: { type: string }
        stockQty: { type: integer }
        branchId: { type: integer }

    ProductCreate:
      type: object
      required: [name, price]
      properties:
        name: { type: string }
        description: { type: string }
        price: { type: number, format: float }
        status: { type: string, enum: [ACTIVE, INACTIVE] }
        branchId: { type: integer, description: "Required for MANAGER. ADMIN uses own branch." }

    ProductUpdate:
      type: object
      properties:
        name: { type: string }
        description: { type: string }
        price: { type: number, format: float }
        status: { type: string, enum: [ACTIVE, INACTIVE] }
        branchId: { type: integer, description: "Only MANAGER can move product to another branch." }

    Order:
      type: object
      properties:
        id: { type: integer }
        status: { type: string, enum: [PENDING, PAID, CANCELLED] }
        total: { type: string }
        tableId: { type: integer }
        branchId: { type: integer }
        createdById: { type: integer }
        items:
          type: array
          items: { $ref: '#/components/schemas/OrderItem' }

    OrderItem:
      type: object
      properties:
        id: { type: integer }
        productId: { type: integer }
        quantity: { type: integer }
        unitPrice: { type: string }
        subtotal: { type: string }

    CreateOrderRequest:
      type: object
      required: [tableId]
      properties:
        tableId: { type: integer }
        notes: { type: string }

    AddItemRequest:
      type: object
      required: [productId, quantity]
      properties:
        productId: { type: integer }
        quantity: { type: integer }

    UpdateItemQtyRequest:
      type: object
      required: [quantity]
      properties:
        quantity: { type: integer, minimum: 1 }

    StockAdjustRequest:
      type: object
      required: [productId, quantity, type]
      properties:
        productId: { type: integer }
        quantity: { type: integer }
        type: { type: string, enum: [IN, OUT, ADJUST] }
        reason: { type: string }

    StockMovement:
      type: object
      properties:
        id: { type: integer }
        type: { type: string, enum: [IN, OUT, ADJUST] }
        quantity: { type: integer }
        reason: { type: string, nullable: true }
        productId: { type: integer }
        branchId: { type: integer }
        orderId: { type: integer, nullable: true }
        createdById: { type: integer }

security:
  - bearerAuth: []
